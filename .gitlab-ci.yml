# ToDo App - Raels Santers

default:
  image: docker:27.0.2-cli-alpine3.20
  services:
    - docker:27.0.2-dind-alpine3.20

variables:
  APP_NAME: todo-app
  DOCKER_TAG: ${CI_COMMIT_SHORT_SHA}
  DOCKER_HUB_USERNAME: "raels0santers"
  DOCKER_DRIVER: overlay2
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_TLS_CERTDIR: ""

stages:
  - build
  - package
  - test
  - staging
  - deploy

# BUILD STAGE
build_app:
  stage: build
  script:
    - echo "Building static files for $APP_NAME"
    - docker build -t ${DOCKER_HUB_USERNAME}/${APP_NAME}:build .
  only:
    - branches

# PACKAGE STAGE
package_app:
  stage: package
  script:
    - echo "Logging in to Docker Hub..."
    - docker login -u "$DOCKER_HUB_USERNAME" -p "$DOCKER_HUB_TOKEN"
    - echo "Tagging and pushing image..."
    - docker tag ${DOCKER_HUB_USERNAME}/${APP_NAME}:build ${DOCKER_HUB_USERNAME}/${APP_NAME}:${DOCKER_TAG}
    - docker push ${DOCKER_HUB_USERNAME}/${APP_NAME}:${DOCKER_TAG}
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        echo "Commit is tagged, pushing tag version..."
        docker tag ${DOCKER_HUB_USERNAME}/${APP_NAME} ${DOCKER_HUB_USERNAME}/${APP_NAME}:${CI_COMMIT_TAG}
        docker push ${DOCKER_HUB_USERNAME}/${APP_NAME}:${CI_COMMIT_TAG}
      fi
  needs: ["build_app"]
  only:
    - branches

# UNIT TEST STAGE
unit_test:
  stage: test
  image: alpine/curl
  script:
    - echo "Running container test for ${APP_NAME}"
    - docker run -d -p 3000:80 --name ${APP_NAME}-test ${DOCKER_HUB_USERNAME}/${APP_NAME}:${DOCKER_TAG}
    - sleep 8
    - curl -s http://localhost:3000 | grep -q "ToDo" && echo "✅ App responded successfully" || (echo "❌ App test failed" && exit 1)
  after_script:
    - docker stop ${APP_NAME}-test || true
  needs: ["package_app"]
  only:
    - branches

# STAGING DEPLOYMENT 
staging_deploy:
  stage: staging
  image: alpine
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
    - echo "Deploying to EC2 staging environment (port 8089)..."
    - ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} "
        docker rm -f ${APP_NAME}-staging || true &&
        docker pull ${DOCKER_HUB_USERNAME}/${APP_NAME}:${DOCKER_TAG} &&
        docker run -d -p 8089:80 --name ${APP_NAME}-staging ${DOCKER_HUB_USERNAME}/${APP_NAME}:${DOCKER_TAG}
      "
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: on_success

# PRODUCTION DEPLOYMENT 
prod_deploy:
  stage: deploy
  image: alpine
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
  script:
    - echo "Deploying to EC2 production (port 80)..."
    - ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} "
        docker rm -f ${APP_NAME}-prod || true &&
        docker pull ${DOCKER_HUB_USERNAME}/${APP_NAME}:${DOCKER_TAG} &&
        docker run -d -p 80:80 --name ${APP_NAME}-prod ${DOCKER_HUB_USERNAME}/${APP_NAME}:${DOCKER_TAG}
      "
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
      when: manual
    - if: '$CI_COMMIT_BRANCH == "main" && $CI_COMMIT_TAG'
      when: on_success
    - when: never
